<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tic-Tac-Toe Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    
    <style>
        body { 
            background: #1a1a1a; 
            color: white; 
            text-align: center; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 90vh;
        }

        h3 { margin-bottom: 5px; color: #fff; }

        #status { 
            margin-bottom: 20px; 
            font-size: 1.4rem; 
            font-weight: bold; 
            height: 30px;
            transition: 0.3s;
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(3, 95px); 
            gap: 12px; 
            justify-content: center; 
        }

        .cell { 
            width: 95px; 
            height: 95px; 
            background: #2a2a2a; 
            border-radius: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 3rem; 
            cursor: pointer; 
            font-weight: 900;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .cell:active { transform: scale(0.95); }

        /* –¶–≤–µ—Ç–∞ –¥–ª—è —Å–∏–º–≤–æ–ª–æ–≤ */
        .x-color { color: #ff4d4d; text-shadow: 0 0 15px rgba(255, 77, 77, 0.4); }
        .o-color { color: #2ecc71; text-shadow: 0 0 15px rgba(46, 204, 113, 0.4); }

        .btn-reset { 
            margin-top: 30px; 
            padding: 12px 25px; 
            border: none; 
            border-radius: 10px; 
            background: #333; 
            color: #ccc; 
            font-weight: bold; 
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-reset:hover { background: #444; color: #fff; }
    </style>
</head>
<body>

    <h3 id="title">–ö—Ä–µ—Å—Ç–∏–∫–∏-–ù–æ–ª–∏–∫–∏</h3>
    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <div class="grid" id="grid"></div>

    <button class="btn-reset" onclick="resetGame()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // 1. –ö–û–ù–§–ò–ì FIREBASE (–¢–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ)
        const firebaseConfig = {
            apiKey: "AIzaSyAHHiHrqqrmCLErO8kxZI1N8bYQ-amk0M",
            authDomain: "tictactoe-tg.firebaseapp.com",
            databaseURL: "https://tictactoe-tg-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tictactoe-tg",
            storageBucket: "tictactoe-tg.firebasestorage.app",
            messagingSenderId: "104026178659",
            appId: "1:104026178659:web:eada04c140696e868ce456"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 2. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ö–û–ú–ù–ê–¢–´
        const urlParams = new URLSearchParams(window.location.search);
        // –ë–µ—Ä–µ–º ID –∏–∑ —Å—Å—ã–ª–∫–∏ (game_id) –∏–ª–∏ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—É—Å–∫–∞ Telegram
        const gameId = urlParams.get('game_id') || tg.initDataUnsafe.start_param || 'global_lobby';
        const gameRef = db.ref('games/' + gameId);

        let board = Array(9).fill("");
        let turn = "X";

        // 3. –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–Ø
        function initGrid() {
            const gridElement = document.getElementById('grid');
            gridElement.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = 'c' + i;
                cell.onclick = () => makeMove(i);
                gridElement.appendChild(cell);
            }
        }

        // 4. –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° –û–ë–õ–ê–ö–û–ú
        gameRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                board = data.board;
                turn = data.turn;
                render(data.winner);
            } else {
                // –ï—Å–ª–∏ –∏–≥—Ä—ã –µ—â–µ –Ω–µ—Ç –≤ –±–∞–∑–µ, —Å–æ–∑–¥–∞–µ–º –µ—ë
                resetGame();
            }
        });

        // 5. –õ–û–ì–ò–ö–ê –•–û–î–ê
        function makeMove(i) {
            if (board[i] === "" && !checkWinner(board)) {
                board[i] = turn;
                const winner = checkWinner(board);
                gameRef.set({
                    board: board,
                    turn: turn === "X" ? "O" : "X",
                    winner: winner
                });
            }
        }

        // 6. –û–¢–†–ò–°–û–í–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê
        function render(winner) {
            board.forEach((val, i) => {
                const cell = document.getElementById('c' + i);
                cell.innerText = val;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ —Å—Ç–∞–≤–∏–º —Ü–≤–µ—Ç–∞
                cell.classList.remove('x-color', 'o-color');
                if (val === "X") cell.classList.add('x-color');
                if (val === "O") cell.classList.add('o-color');
            });

            const status = document.getElementById('status');
            if (winner) {
                if (winner === "Draw") {
                    status.innerText = "ü§ù –ù–∏—á—å—è!";
                    status.style.color = "#aaa";
                } else {
                    status.innerText = "üéâ –ü–æ–±–µ–¥–∏–ª " + winner + "!";
                    status.style.color = (winner === "X") ? "#ff4d4d" : "#2ecc71";
                }
            } else {
                status.innerText = "–•–æ–¥: " + turn;
                status.style.color = (turn === "X") ? "#ff4d4d" : "#2ecc71";
            }
        }

        // 7. –°–ë–†–û–° –ò–ì–†–´
        function resetGame() {
            gameRef.set({
                board: Array(9).fill(""),
                turn: "X",
                winner: null
            });
        }

        // –ü–†–û–í–ï–†–ö–ê –ü–û–ë–ï–î–ò–¢–ï–õ–Ø
        function checkWinner(b) {
            const lines = [
                [0,1,2], [3,4,5], [6,7,8], // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
                [0,3,6], [1,4,7], [2,5,8], // –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
                [0,4,8], [2,4,6]           // –¥–∏–∞–≥–æ–Ω–∞–ª–∏
            ];
            for (let l of lines) {
                if (b[l[0]] && b[l[0]] === b[l[1]] && b[l[0]] === b[l[2]]) return b[l[0]];
            }
            return b.includes("") ? null : "Draw";
        }

        initGrid();
    </script>
</body>
</html>