<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #1a1a1a; color: white; text-align: center; font-family: sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 95vh; }
        .grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; width: 95vw; max-width: 400px; background: #444; padding: 2px; border-radius: 5px; }
        .cell { aspect-ratio: 1/1; background: #333; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; font-weight: bold; }
        .x-color { color: #ff4d4d; }
        .o-color { color: #2ecc71; }
        #status { margin-bottom: 10px; font-size: 0.9rem; font-weight: bold; color: #00ccff; }
        #debug { font-size: 0.7rem; color: #666; margin-top: 5px; }
        button { margin-top: 10px; padding: 8px 16px; border: none; border-radius: 5px; background: #444; color: white; }
    </style>
</head>
<body>
    <div id="status">Загрузка...</div>
    <div class="grid" id="grid"></div>
    <button onclick="resetGame()">Сброс игры</button>
    <div id="debug"></div>

    <script>
        var tg = window.Telegram.WebApp;
        tg.expand();

        // Генерируем ID, если Telegram его не дал (для тестов вне ТГ)
        var myId = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user.id : "user_" + Math.floor(Math.random() * 1000000);
        document.getElementById('debug').innerText = "Ваш ID: " + myId;

        var firebaseConfig = {
            apiKey: "AIzaSyAHHiHrqqrmCLErO8kxZI1N8bYQ-amk0M",
            authDomain: "tictactoe-tg.firebaseapp.com",
            databaseURL: "https://tictactoe-tg-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tictactoe-tg",
            storageBucket: "tictactoe-tg.firebasestorage.app",
            messagingSenderId: "104026178659",
            appId: "1:104026178659:web:eada04c140696e868ce456"
        };
        
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();
        var urlParams = new URLSearchParams(window.location.search);
        var gameId = urlParams.get('game_id') || 'lobby_default';
        var gameRef = db.ref('games/' + gameId);

        var size = 10;
        var board = Array(100).fill("");
        var turn = "X", playerX = null, playerO = null;

        function initGrid() {
            var gridElement = document.getElementById('grid');
            gridElement.innerHTML = '';
            for (var i = 0; i < 100; i++) {
                var cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = 'c' + i;
                (function(idx) { cell.onclick = function() { makeMove(idx); }; })(i);
                gridElement.appendChild(cell);
            }
        }

        gameRef.on('value', function(snapshot) {
            var data = snapshot.val();
            if (data) {
                board = data.board || Array(100).fill("");
                turn = data.turn || "X";
                playerX = data.playerX || null;
                playerO = data.playerO || null;
                render(data.winner);
            } else { resetGame(); }
        });

        function makeMove(i) {
            if (board[i] !== "" || checkWinnerLogic()) return;

            // Назначение ролей "на лету"
            if (turn === "X") {
                if (!playerX) playerX = myId; 
                if (myId !== playerX) { tg.showAlert("Это не ваш ход! (Вы не X)"); return; }
            } else {
                if (!playerO && myId !== playerX) playerO = myId;
                if (myId !== playerO) { 
                    if (myId === playerX) tg.showAlert("Вы играете за X, ждите противника!");
                    else tg.showAlert("Это не ваш ход!");
                    return; 
                }
            }

            board[i] = turn;
            tg.HapticFeedback.impactOccurred('light');
            gameRef.set({
                board: board,
                turn: (turn === "X" ? "O" : "X"),
                winner: checkWinnerLogic(),
                playerX: playerX,
                playerO: playerO
            });
        }

        function render(winner) {
            for (var i = 0; i < 100; i++) {
                var cell = document.getElementById('c' + i);
                cell.innerText = board[i];
                cell.className = 'cell ' + (board[i] === 'X' ? 'x-color' : (board[i] === 'O' ? 'o-color' : ''));
            }
            var status = document.getElementById('status');
            var role = (myId === playerX) ? " (Вы за X)" : (myId === playerO ? " (Вы за O)" : " (Зритель)");
            if (winner) {
                status.innerText = winner === "Draw" ? "Ничья!" : "Победил " + winner + "!";
            } else {
                status.innerText = "Ход: " + turn + role;
            }
        }

        function resetGame() {
            gameRef.set({ board: Array(100).fill(""), turn: "X", winner: null, playerX: null, playerO: null });
        }

        function checkWinnerLogic() {
            for (var i = 0; i < 100; i++) {
                if (board[i] === "") continue;
                var r = Math.floor(i / 10), c = i % 10;
                if (checkDir(r, c, 0, 1) || checkDir(r, c, 1, 0) || checkDir(r, c, 1, 1) || checkDir(r, c, 1, -1)) return board[i];
            }
            return board.indexOf("") === -1 ? "Draw" : null;
        }

        function checkDir(r, c, dr, dc) {
            var symbol = board[r * 10 + c];
            for (var i = 1; i < 5; i++) {
                var nr = r + dr * i, nc = c + dc * i;
                if (nr < 0 || nr >= 10 || nc < 0 || nc >= 10 || board[nr * 10 + nc] !== symbol) return false;
            }
            return true;
        }

        initGrid();
    </script>
</body>
</html>