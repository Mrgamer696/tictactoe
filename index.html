<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #1a1a1a; color: white; text-align: center; font-family: sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 95vh; }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            gap: 4px; 
            width: 95vw; 
            max-width: 400px;
            background: #444;
            padding: 4px;
            border-radius: 8px;
        }
        .cell { 
            aspect-ratio: 1/1;
            background: #333; 
            border-radius: 4px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.2rem; 
            cursor: pointer; 
            font-weight: bold; 
        }
        .x-color { color: #ff4d4d; }
        .o-color { color: #2ecc71; }
        #status { margin-bottom: 15px; font-size: 1rem; font-weight: bold; color: #00ccff; height: 20px; }
        button { margin-top: 15px; padding: 8px 16px; border-radius: 8px; border: none; background: #444; color: white; cursor: pointer; }
    </style>
</head>
<body>
    <div id="status">Загрузка...</div>
    <div class="grid" id="grid"></div>
    <button onclick="resetGame()">Сброс</button>

    <script>
        var tg = window.Telegram.WebApp;
        tg.expand();
        var myId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "guest_" + Math.random();

        var firebaseConfig = {
            apiKey: "AIzaSyAHHiHrqqrmCLErO8kxZI1N8bYQ-amk0M",
            authDomain: "tictactoe-tg.firebaseapp.com",
            databaseURL: "https://tictactoe-tg-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tictactoe-tg",
            storageBucket: "tictactoe-tg.firebasestorage.app",
            messagingSenderId: "104026178659",
            appId: "1:104026178659:web:eada04c140696e868ce456"
        };
        
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();
        var urlParams = new URLSearchParams(window.location.search);
        var gameId = urlParams.get('game_id') || 'lobby_10x10';
        var gameRef = db.ref('games/' + gameId);

        var size = 10;
        var board = Array(size * size).fill("");
        var turn = "X", playerX = null, playerO = null;

        function initGrid() {
            var gridElement = document.getElementById('grid');
            gridElement.innerHTML = '';
            for (var i = 0; i < size * size; i++) {
                (function(index) {
                    var cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = 'c' + index;
                    cell.onclick = function() { makeMove(index); };
                    gridElement.appendChild(cell);
                })(i);
            }
        }

        gameRef.on('value', function(snapshot) {
            var data = snapshot.val();
            if (data) {
                board = data.board; turn = data.turn;
                playerX = data.playerX; playerO = data.playerO;
                render(data.winner);
            } else { resetGame(); }
        });

        function makeMove(i) {
            if (board[i] !== "" || checkWinnerLogic()) return;

            // Назначение ролей
            if (turn === "X") {
                if (!playerX) playerX = myId;
                else if (myId !== playerX) { tg.showAlert("Ход Крестиков!"); return; }
            } else {
                if (myId === playerX) { tg.showAlert("Вы за X! Ждите оппонента."); return; }
                if (!playerO) playerO = myId;
                else if (myId !== playerO) { tg.showAlert("Ход Ноликов!"); return; }
            }

            board[i] = turn;
            tg.HapticFeedback.impactOccurred('light');
            gameRef.set({
                board: board,
                turn: (turn === "X" ? "O" : "X"),
                winner: checkWinnerLogic(),
                playerX: playerX, playerO: playerO
            });
        }

        function render(winner) {
            board.forEach(function(val, i) {
                var cell = document.getElementById('c' + i);
                cell.innerText = val;
                cell.className = 'cell ' + (val === 'X' ? 'x-color' : (val === 'O' ? 'o-color' : ''));
            });
            var status = document.getElementById('status');
            var role = (myId === playerX) ? " (Вы X)" : (myId === playerO ? " (Вы O)" : "");
            status.innerText = winner ? (winner === "Draw" ? "Ничья!" : "Победа " + winner) : "Ход: " + turn + role;
        }

        function resetGame() {
            gameRef.set({ board: Array(100).fill(""), turn: "X", winner: null, playerX: null, playerO: null });
        }

        function checkWinnerLogic() {
            for (let i = 0; i < 100; i++) {
                if (board[i] === "") continue;
                let r = Math.floor(i / 10), c = i % 10;
                // Проверка в 4 направлениях: вправо, вниз, диагональ вправо-вниз, диагональ влево-вниз
                if (checkDir(r, c, 0, 1) || checkDir(r, c, 1, 0) || checkDir(r, c, 1, 1) || checkDir(r, c, 1, -1)) return board[i];
            }
            return board.indexOf("") === -1 ? "Draw" : null;
        }

        function checkDir(r, c, dr, dc) {
            let symbol = board[r * 10 + c];
            for (let i = 1; i < 5; i++) {
                let nr = r + dr * i, nc = c + dc * i;
                if (nr < 0 || nr >= 10 || nc < 0 || nc >= 10 || board[nr * 10 + nc] !== symbol) return false;
            }
            return true;
        }

        initGrid();
    </script>
</body>
</html>