<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #1a1a1a; color: white; text-align: center; font-family: sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; }
        .grid { display: grid; grid-template-columns: repeat(3, 90px); gap: 10px; justify-content: center; }
        .cell { width: 90px; height: 90px; background: #333; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; cursor: pointer; font-weight: bold; transition: 0.1s; }
        .cell:active { transform: scale(0.95); }
        .x-color { color: #ff4d4d; }
        .o-color { color: #2ecc71; }
        #status { margin-bottom: 20px; font-size: 1.1rem; height: 40px; font-weight: bold; color: #00ccff; }
        button { margin-top: 25px; padding: 10px 20px; border-radius: 8px; border: none; background: #444; color: white; cursor: pointer; }
    </style>
</head>
<body>
    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="grid" id="grid"></div>
    <button onclick="resetGame()">–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É</button>

    <script>
        var tg = window.Telegram.WebApp;
        tg.expand();

        var myId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;

        var firebaseConfig = {
            apiKey: "AIzaSyAHHiHrqqrmCLErO8kxZI1N8bYQ-amk0M",
            authDomain: "tictactoe-tg.firebaseapp.com",
            databaseURL: "https://tictactoe-tg-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tictactoe-tg",
            storageBucket: "tictactoe-tg.firebasestorage.app",
            messagingSenderId: "104026178659",
            appId: "1:104026178659:web:eada04c140696e868ce456"
        };
        
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();

        var urlParams = new URLSearchParams(window.location.search);
        var gameId = urlParams.get('game_id') || (tg.initDataUnsafe && tg.initDataUnsafe.start_param) || 'lobby';
        var gameRef = db.ref('games/' + gameId);

        var board = ["","","","","","","","",""];
        var turn = "X";
        var playerX = null;
        var playerO = null;

        function initGrid() {
            var gridElement = document.getElementById('grid');
            gridElement.innerHTML = '';
            for (var i = 0; i < 9; i++) {
                (function(index) {
                    var cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = 'c' + index;
                    cell.onclick = function() { makeMove(index); };
                    gridElement.appendChild(cell);
                })(i);
            }
        }

        gameRef.on('value', function(snapshot) {
            var data = snapshot.val();
            if (data) {
                board = data.board;
                turn = data.turn;
                playerX = data.playerX || null;
                playerO = data.playerO || null;
                render(data.winner);
            } else {
                resetGame();
            }
        });

        function makeMove(i) {
            if (board[i] !== "" || checkWinner(board)) return;

            // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π
            if (turn === "X") {
                if (!playerX) {
                    playerX = myId;
                } else if (myId !== playerX) {
                    tg.showAlert("–°–µ–π—á–∞—Å —Ö–æ–¥ –ö—Ä–µ—Å—Ç–∏–∫–æ–≤, –∞ –≤—ã ‚Äî –Ω–µ –æ–Ω!");
                    return;
                }
            } else if (turn === "O") {
                // –ó–∞–ø—Ä–µ—Ç –∏–≥—Ä–æ–∫—É X —Ö–æ–¥–∏—Ç—å –∑–∞ O
                if (myId === playerX) {
                    tg.showAlert("–í—ã –∏–≥—Ä–∞–µ—Ç–µ –∑–∞ –ö—Ä–µ—Å—Ç–∏–∫–∏! –ñ–¥–∏—Ç–µ —Ö–æ–¥–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞.");
                    return;
                }
                if (!playerO) {
                    playerO = myId;
                } else if (myId !== playerO) {
                    tg.showAlert("–°–µ–π—á–∞—Å —Ö–æ–¥ –ù–æ–ª–∏–∫–æ–≤, –∞ –≤—ã ‚Äî –Ω–µ –æ–Ω!");
                    return;
                }
            }

            board[i] = turn;
            gameRef.set({
                board: board,
                turn: (turn === "X" ? "O" : "X"),
                winner: checkWinner(board),
                playerX: playerX,
                playerO: playerO
            });
        }

        function render(winner) {
            for (var i = 0; i < 9; i++) {
                var cell = document.getElementById('c' + i);
                cell.innerText = board[i];
                cell.className = 'cell ' + (board[i] === 'X' ? 'x-color' : (board[i] === 'O' ? 'o-color' : ''));
            }
            var status = document.getElementById('status');
            var role = "";
            if (myId === playerX) role = " (–í—ã –∑–∞ X)";
            else if (myId === playerO) role = " (–í—ã –∑–∞ O)";
            else if (playerX && playerO) role = " (–ó—Ä–∏—Ç–µ–ª—å)";

            if (winner) {
                status.innerText = (winner === "Draw" ? "ü§ù –ù–∏—á—å—è!" : "üéâ –ü–æ–±–µ–¥–∏–ª " + winner);
            } else {
                status.innerText = "–•–æ–¥: " + turn + role;
            }
        }

        function resetGame() {
            gameRef.set({ 
                board: ["","","","","","","","",""], 
                turn: "X", 
                winner: null,
                playerX: null,
                playerO: null 
            });
        }

        function checkWinner(b) {
            var lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (var i = 0; i < lines.length; i++) {
                var l = lines[i];
                if (b[l[0]] && b[l[0]] === b[l[1]] && b[l[0]] === b[l[2]]) return b[l[0]];
            }
            return b.indexOf("") === -1 ? "Draw" : null;
        }

        initGrid();
    </script>
</body>
</html>